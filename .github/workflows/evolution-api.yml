name: Evolution API Server

on:
  workflow_dispatch:  # Manual trigger from GitHub UI
  schedule:
    - cron: '0 */6 * * *'  # Auto-restart every 6 hours

jobs:
  run-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
      - name: Start Evolution API
        run: |
          docker run -d \
            --name evolution_api \
            -p 8080:8080 \
            -e AUTHENTICATION_API_KEY=${{ secrets.API_KEY }} \
            atendai/evolution-api

      - name: Wait for API to be ready
        run: |
          echo "Waiting for Evolution API to start..."
          for i in $(seq 1 30); do
            if curl -s http://localhost:8080 > /dev/null 2>&1; then
              echo "Evolution API is up!"
              break
            fi
            echo "Attempt $i/30 - waiting 5s..."
            sleep 5
          done

      - name: Install and start Cloudflare Tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          ./cloudflared tunnel --url http://localhost:8080 &
          sleep 10

      - name: Print public URL
        run: |
          echo "============================================"
          echo "  Fetching tunnel URL..."
          echo "============================================"
          sleep 5
          # cloudflared prints the URL to stderr, grab it from the log
          curl -s http://localhost:8080 > /dev/null
          # The URL is shown in the cloudflared output above
          echo ""
          echo "Check the 'Install and start Cloudflare Tunnel' step logs for your public URL"
          echo "It looks like: https://xxxxx-xxxx-xxxx.trycloudflare.com"
          echo ""
          echo "API Docs:    <your-url>/docs"
          echo "Manager UI:  <your-url>/manager"
          echo "============================================"

      - name: Keep alive
        run: |
          echo "Server is running. Will stay alive for ~6 hours."
          echo "Started at: $(date -u)"
          while true; do
            sleep 300
            if ! docker ps | grep -q evolution_api; then
              echo "Container died, restarting..."
              docker start evolution_api
            fi
            echo "Still alive at: $(date -u)"
          done
