name: OCI Instance Auto-Retry

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  create-instance:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    steps:
      - name: Install OCI CLI
        run: pip install oci-cli

      - name: Configure OCI CLI
        run: |
          mkdir -p ~/.oci

          echo "${{ secrets.OCI_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

          cat <<'CONFEOF' > ~/.oci/config
          [DEFAULT]
          user=ocid1.user.oc1..aaaaaaaa2vadufabj773jrg4ut7oq5ijq7awnxu36w7rwpib2ijvscui6dyq
          fingerprint=02:66:cd:9a:01:50:1f:a9:dc:4e:8e:ea:e4:50:06:d6
          tenancy=ocid1.tenancy.oc1..aaaaaaaa2jmzp6bq7fovdlqsn3vyjtrvpvjogfwwrbexzgwttk442uxawhna
          region=me-dubai-1
          key_file=~/.oci/oci_api_key.pem
          CONFEOF
          chmod 600 ~/.oci/config

      - name: Check if instance already exists
        id: check
        run: |
          existing=$(oci compute instance list \
            --compartment-id "ocid1.tenancy.oc1..aaaaaaaa2jmzp6bq7fovdlqsn3vyjtrvpvjogfwwrbexzgwttk442uxawhna" \
            --display-name "chat-api" \
            --lifecycle-state RUNNING \
            2>&1) || true

          if echo "$existing" | grep -q '"display-name": "chat-api"'; then
            echo "Instance already exists! Skipping."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "No existing instance found. Will create."
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Retry until instance is created
        if: steps.check.outputs.exists != 'true'
        run: |
          attempt=0
          while true; do
            attempt=$((attempt + 1))
            echo "=== Attempt #$attempt - $(date) ==="

            result=$(oci compute instance launch \
              --compartment-id "ocid1.tenancy.oc1..aaaaaaaa2jmzp6bq7fovdlqsn3vyjtrvpvjogfwwrbexzgwttk442uxawhna" \
              --availability-domain "CVBu:ME-DUBAI-1-AD-1" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 1, "memoryInGBs": 6}' \
              --image-id "ocid1.image.oc1.me-dubai-1.aaaaaaaam643oym7o66pe5omdc5fqcjwaybj3z23erlvjzotovsdfag5yfla" \
              --subnet-id "ocid1.subnet.oc1.me-dubai-1.aaaaaaaaeybpy3em73nevvsmntkiqnh3nkkzx4aprt4egcs7jz6yg22untdq" \
              --display-name "chat-api" \
              --assign-public-ip true \
              --ssh-authorized-keys-file <(echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOKI84BhKq+00AFymwx2b8K6r/QHwk8DUiWodlN/2dyv evolution-api-oci") \
              2>&1) || true

            echo "$result"

            if echo "$result" | grep -q '"lifecycle-state"'; then
              echo ""
              echo "========================================="
              echo "SUCCESS! Instance created!"
              echo "========================================="
              exit 0
            fi

            echo "Failed. Retrying in 5 minutes..."
            sleep 300
          done
