name: Deploy to Oracle Cloud

on:
  push:
    branches: [main]
  workflow_dispatch:

# ============================================================
# SETUP: Add these 4 secrets to your GitHub repo:
# Repo → Settings → Secrets and variables → Actions → New repository secret
#
# 1. SERVER_IP
#    → OCI Console → Compute → Instances → click your instance
#    → copy the "Public IP address" shown
#
# 2. SSH_PRIVATE_KEY
#    → On your local machine run: cat ~/.ssh/oci_evolution
#    → Copy EVERYTHING including -----BEGIN/END----- lines
#
# 3. API_KEY
#    → Pick any strong key for the Evolution API
#    → Example: PXxXIPelBnpKh/hjYvwFAIHtFaFelJTyhb2JP147FoQ=
#
# 4. POSTGRES_PASSWORD
#    → Pick any strong password for the database
#    → Example: MyStr0ngP@ssw0rd!2026
#
# You can delete the old OCI_KEY secret — it's no longer needed.
# ============================================================

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Install Docker on server
        run: |
          ssh -i ~/.ssh/key -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
          if ! command -v docker &> /dev/null; then
            echo "Installing Docker..."
            curl -fsSL https://get.docker.com | sh
            sudo usermod -aG docker $USER
          else
            echo "Docker already installed"
          fi
          EOF

      - name: Open firewall ports
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
          if ! sudo iptables -C INPUT -p tcp --dport 80 -j ACCEPT 2>/dev/null; then
            sudo iptables -I INPUT 6 -m state --state NEW -p tcp --dport 80 -j ACCEPT
            sudo iptables -I INPUT 6 -m state --state NEW -p tcp --dport 443 -j ACCEPT
            sudo netfilter-persistent save
            echo "Firewall ports opened"
          else
            echo "Firewall ports already open"
          fi
          EOF

      - name: Deploy application
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
          # Create app directory
          mkdir -p ~/whatsapp
          EOF

          # Copy files to server
          scp -i ~/.ssh/key docker-compose.yml ubuntu@${{ secrets.SERVER_IP }}:~/whatsapp/
          scp -i ~/.ssh/key nginx.conf ubuntu@${{ secrets.SERVER_IP }}:~/whatsapp/

          # Create .env on server
          ssh -i ~/.ssh/key ubuntu@${{ secrets.SERVER_IP }} << EOF
          cat > ~/whatsapp/.env << 'ENVEOF'
          AUTHENTICATION_API_KEY=${{ secrets.API_KEY }}
          SERVER_IP=${{ secrets.SERVER_IP }}
          POSTGRES_USER=evolution
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          ENVEOF
          EOF

      - name: Start services
        run: |
          ssh -i ~/.ssh/key ubuntu@${{ secrets.SERVER_IP }} << 'EOF'
          cd ~/whatsapp
          sudo docker compose pull
          sudo docker compose up -d
          echo ""
          echo "========================================="
          echo "Waiting 30s for services to start..."
          sleep 30
          sudo docker compose ps
          echo "========================================="
          EOF
